  name: CI Pipeline

  on:
    pull_request:
      branches: [ master ]
    push:
      branches: [ master ]

  jobs:
    build-test:
      name: Build & Test
      runs-on: ubuntu-latest
      steps:
        - name: Checkout repository
          uses: actions/checkout@v4

        - name: Set up JDK 17
          uses: actions/setup-java@v4
          with:
            distribution: 'temurin'
            java-version: '17'

        - name: Build & run tests with Maven
          run: mvn clean verify --batch-mode

        - name: Build Docker image
          run: docker build -t demo-app .

    sonarqube:
      name: SonarQube Analysis
      runs-on: ubuntu-latest
      needs: build-test
      steps:
        - name: Checkout repository
          uses: actions/checkout@v4

        - name: Set up JDK 17
          uses: actions/setup-java@v4
          with:
            distribution: 'temurin'
            java-version: '17'

        - name: SonarQube Scan
          uses: SonarSource/sonarqube-scan-action@v2
          with:
            args: >
              -Dsonar.projectKey=sliepniev
              -Dsonar.projectName=sliepniev
              -Dsonar.host.url=https://sonarcloud.io
              -Dsonar.login=${{ secrets.SONAR_TOKEN }}
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
